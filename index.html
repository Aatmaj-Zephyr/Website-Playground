<!--kjsce page -->
<html>

<link rel="stylesheet" href="mystyle.css">
<script src="https://use.fontawesome.com/49b98aaeb5.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-messaging.js"></script>

<link rel="manifest" href="manifest.json" />     

<body class="kjscePageBody">
    <div class="classNotifications">
        <div class="notificationClass1" onclick="myFunction(1)">
            <div class="notificationsSport">
                <div class="heartVector">
                    <i class="fa fa-heart"
                        style="color:#fa0303; text-shadow: -1px 0 #000, 0 1px #000, 1px 0 #000, 0 -1px #000;"></i>
                </div>
                <div class="likesCountSmallDisplay">
                    4
                </div>
                <div class="timeSmallDisplay">
                    4:15-5:15
                </div>
                <div class="playersSmallDisplay">
                    7/10
                </div>
                <div class="sportIcon">
                </div>
                <div class="titleSmall">
                    BASKETBALL
                </div>
                <div class="horizontalLine">
                </div>
                <div class=" sportTag">
                    Sport
                </div>
            </div>
        </div>
    </div>
    <div class="addEventButton" onclick="newNotification()">
        <div class="addEventButtonText">
        ADD EVENT
    </div>
    </div>
  
  
</div>
  <body>
   
   
   <script>
      window.addEventListener('load', () => {
        registerSW();
      });
   
      // Register the Service Worker
      async function registerSW() {
        console.log('Registering service worker for app');

        if ('serviceWorker' in navigator) {
          try {
            await navigator
                  .serviceWorker
                  .register('serviceworker.js');
          }
          catch (e) {
            console.log('SW registration for app failed');
            console.log(e.message);
          }
        }
      }


   </script>
<script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js ">
</script>
<script>
    const firebaseConfig = {
  apiKey: "AIzaSyA4DEsfJ0EZJRqEoGVYWEcHo53I1flmgPA",
  authDomain: "mini-project-sem-3.firebaseapp.com",
  databaseURL: "https://mini-project-sem-3-default-rtdb.firebaseio.com",
  projectId: "mini-project-sem-3",
  storageBucket: "mini-project-sem-3.appspot.com",
  messagingSenderId: "881818336366",
  appId: "1:881818336366:web:e5bf2fb22315ce1b7eba7f",
  measurementId: "G-0LZFL2KQCV"
};
firebase.initializeApp(firebaseConfig);
fetchFromFireBase();
function fetchFromFireBase(){ //fetch from firebase
var likesCountRef = firebase.database().ref('Event/Likes');
likesCountRef.on('value', (snapshot) => {
  const data = snapshot.val();
//  updateLikesCount(postElement, data);
  console.log(data);
});
var likesCountRef = firebase.database().ref('Event');
likesCountRef.on('value', (snapshot) => {
  const data = snapshot.val();
  console.log(data);
  newNotification(data.time,data.Name,data.RegisteredPlayers+"/"+ data.Players,data.Likes)
});
}
   
    var notificationCount = 1;
    function myFunction(a) {
        var notificationBox = document.querySelector(".classNotifications").querySelector(".notificationClass" + a);
        notificationBox.querySelector(".likesCountSmallDisplay").innerHTML = parseInt(notificationBox.querySelector(".likesCountSmallDisplay").innerHTML) + 1;

        window.location.href="/eventPage.html";

    }
 
    function newNotification( time,title,players,likes) {

       
        notificationCount+=1;
        var classNotifications = document.querySelector(".classNotifications")
       // var likes = 5;//fetch
      //  var time = "2:15-3:15" //fetch
     //   var players = "3/10"//fetch
        var type = "sport"//fetch
      //  var title = "Badmington" //fetch

        var newNotification =
            "   \
            <div class=\" notificationClass"+notificationCount+"\"   onclick=\" myFunction("+notificationCount+")\" > \
            <div class=\" notifications"+ type + "\" >                                                            \
                <div class=\" heartVector\" >                                                           \
                    <i class=\"fa fa-heart\" style=\"color:#fa0303; text-shadow: -1px 0 #000, 0 1px #000, 1px 0 #000, 0 -1px #000;\"></i>\
                </div>                                                          \
                <div class=\" likesCountSmallDisplay\" >                                                            \
                    "+likes+"                                                           \
                </div>                                                          \
                <div class=\" timeSmallDisplay\" >                                                          \
                    "+time+    "                                                       \
                </div>                                                          \
                <div class=\" playersSmallDisplay\" >                                                           \
                  "+players+"                                                        \
                </div>                                                                          \
                <div class=\" "+ type + "Icon\" >                                                         \
                </div>                                                              \
                <div class=\" titleSmall\" >                                                            \
                    "+title.toUpperCase()+"                                                          \
                </div>                                                          \
                <div class=\" horizontalLine\" >                                                            \
                </div>                                                          \
                <div class=\"  "+ type + "Tag\" >                                                         \
                    "+ type + "                                                           \
                </div>                                                          \
            </div></div>                                                            \
            "
        classNotifications.innerHTML += newNotification

//send notification from app

  const notifTitle = title;
  const notifBody = `New `+ type + " " + title + ' is added with ' + players;
  const notifImg = `/images/icon-192x192.jpg`;
  const options = {
    body: notifBody, //body of app
    icon: notifImg, //icon of app
    vibrate: [200, 100, 200]
  };
 
  Notification.requestPermission().then((result) => {
    if (result === 'granted') {
notify(notifTitle,options)
    }
   
  });
  
    }
   
function notify(notifTitle,options){
 new Notification(notifTitle, options);

}

    const messaging = firebase.messaging();
// Add the public key generated from the console here.
messaging.getToken(messaging, {vapidKey: "BHgxjQxVuZKBKvWQTXd8ZQUPiuTJyo9q-teOcIVXxlgX9PfyREtU8cuY0V6DhWOgr9K0HQ86EdhstKFMUb_QyEQ"})

function requestPermission() {
  console.log('Requesting permission...');
  Notification.requestPermission().then((permission) => {
    if (permission === 'granted') {
      console.log('Notification permission granted.');
    }
  });
}

// Get registration token. Initially this makes a network call, once retrieved
// subsequent calls to getToken will return from cache.
messaging.getToken({ vapidKey: 'BJPJ4Ba80OZGK3xiRceIVpfCLa0K6HsjY6jRUz4jKDX18ko9j1s4ZtLdkzhEbLmjtjKeMPkktp_YQynAeEhvVCg' })
     .then((currentToken) => {
  if (currentToken) {
    // Send the token to your server and update the UI if necessary
    // ...
    console.log("current token exists");
    console.log(currentToken)
  } else {
    // Show permission request UI
    console.log('No registration token available. Request permission to generate one.');
    // ...
  }
}).catch((err) => {
  console.log('An error occurred while retrieving token. ', err);
  // ...
});
/*
messaging.onMessage((payload) => {
  console.log('[firebase-messaging-sw.js] Received background message ', payload);
  console.log("Message recieved from server")
  // Customize notification here
  const notificationTitle = 'Background Message Title';
  const notificationOptions = {
    body: 'Background Message body.',
    icon: '/firebase-logo.png'
  };

  self.registration.showNotification(notificationTitle,
    notificationOptions);
});*/

    /*
    window.addEventListener('load', e => {
      subscribeToPushNotification();
      checkIfPushIsEnabled();
    });
    function checkIfPushIsEnabled() {
    //---check if push notification permission has been denied by the user---
    if (Notification.permission === 'denied') {
        console.log('User has blocked push notification.');
        return;
    }
    //---check if push notification is supported or not---
    if (!('PushManager' in window)) {
        console.log('Sorry, Push notification is ' + 'not supported on this browser.');
        return;
    }
    //---get push notification subscription if serviceWorker is registered and ready---
    navigator.serviceWorker.ready
    .then(function (registration) {
        registration.pushManager.getSubscription()
        .then(function (subscription) {
            if (subscription) {
                //---user is currently subscribed to push---
            console.log("user is currently subscribed to push");
            }
            else {
                //---user is not subscribed to push---
                console.log("user is not subscribed to push");
            }
        })
        .catch(function (error) {
            console.error('Error occurred enabling push ', error);
        });
    });
}
    
      function subscribeToPushNotification() {
    navigator.serviceWorker.ready
    .then(function(registration) {
      console.log('Push notification subscribing.');

        if (!registration.pushManager) {
            alert('This browser does not ' + 'support push notification.');
            return false;
        }
        //---to subscribe push notification using pushmanager---
        registration.pushManager.subscribe(
        //---always show notification when received---
        { userVisibleOnly: true }
        )
        .then(function (subscription) {
            console.log('Push notification subscribed.');
            console.log(subscription);
        })
        .catch(function (error) {
            console.log('Push notification subscription error: ', error);
        });
    })
}
*/
</script>
</body>

</html>
